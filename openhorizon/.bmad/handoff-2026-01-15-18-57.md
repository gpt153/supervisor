# Supervisor Handoff Document

**Project:** OpenHorizon
**Handoff Date:** 2026-01-15 18:57 (Stockholm time)
**From:** Supervisor Instance (Session: 603629fa-0853-4ff8-852b-da8a793a21f2)
**To:** Next Supervisor Instance
**Reason:** Proactive context management (approaching 70K tokens)

---

## Executive Summary

**Current Phase:** Implementation (91% complete) â†’ Testing & Production Readiness

**Critical Context:**
- Samuel is the sole user, managing 3-5 Erasmus+ projects for his Swedish fÃ¶rening
- Business model: Financial transparency tool enabling informed margin decisions (break-even vs. profitable projects)
- **CRITICAL BLOCKER:** Vendor search agents (Food/Accommodation) timeout at 30 seconds, blocking core value proposition
- February 2026 deadline for real project applications

**What Just Happened:**
1. Completed comprehensive codebase research and planning artifacts backfill
2. User corrected business model understanding (not "democratize access", but sustainable project management with profit visibility)
3. Created 10 GitHub issues total: 1 quick win + 9 for Epic 001 (API timeout fix)
4. Started SCAR on issue #105 (profit display) - currently in progress
5. SCAR has been working on #105 for ~28 minutes

**What's Next:**
- Verify SCAR completes #105 successfully
- Direct SCAR to Epic 001 starting with #106 (Database SearchJob model)
- Supervise Epic 001 implementation through #106-#114

---

## Active Work (RIGHT NOW)

### SCAR Working: Issue #105
- **Title:** Frontend: Add profit/margin display to Pipeline Project Detail page
- **Status:** In progress (~28 minutes elapsed, SCAR still working)
- **URL:** https://github.com/gpt153/openhorizon.cc/issues/105
- **Worktree:** `/home/samuel/.archon/worktrees/openhorizon.cc/issue-105/`
- **What to do:**
  1. Wait for SCAR to complete and post completion comment
  2. Verify implementation (profit cards appear on project detail page)
  3. Test at: `/home/samuel/.archon/worktrees/openhorizon.cc/issue-105/app/src/app/(dashboard)/pipeline/projects/[id]/page.tsx`
  4. Look for: 4-card grid showing Grant Amount, Estimated Costs, Profit, Margin %
  5. If correct: Post "@scar APPROVED âœ… Create PR and merge"
  6. If issues: Post detailed feedback with specific problems

### Expected Timeline
- **#105 completion:** Within next 10-20 minutes (it's a 5-10 minute task, SCAR may be debugging)
- **Epic 001 start:** Immediately after #105 verified

---

## Critical Business Context

### Real Business Model (User Correction on 2026-01-15)

**What I initially got WRONG:**
- âŒ Framed as "democratize Erasmus+ access for all organizations"
- âŒ Focus on "social impact" and "altruistic mission"

**What it ACTUALLY is:**
- âœ… Samuel's sustainable income tool for his own Erasmus+ projects
- âœ… Budget calculator shows Erasmus+ grant amount (EU income)
- âœ… Vendor search finds accommodation/food/travel options
- âœ… Profit Dashboard tracks: Grant - Costs = Profit/Salary
- âœ… Some projects are break-even (community impact), others profitable (income)
- âœ… KEY: Financial transparency enables informed margin decisions per project

### Why Vendor Search is CRITICAL
Without working vendor search:
- Cannot find accommodation/food pricing
- Cannot calculate true project costs
- Cannot see profit margins
- Cannot make informed decisions about which projects to pursue
- **Blocks entire February 2026 deadline** (3-5 real projects to plan)

### Profit Visibility Requirements
User said: "i need to see profit in every project, not only in the main dashboard"

**Current state:**
- âœ… Main Profit Dashboard: Shows all projects' financials
- âœ… Pipeline Projects List: Shows margin % on cards
- âš ï¸ Pipeline Project Detail: Data calculated but NOT displayed (#105 fixes this)
- âŒ Regular Projects: No financial data in schema (deferred)

---

## GitHub Issues Status

### Created Today (2026-01-15)

**Issue #105: Profit Display (Quick Win)**
- Status: In progress (SCAR working)
- Priority: HIGH
- Estimated time: 5-10 minutes
- File: `app/src/app/(dashboard)/pipeline/projects/[id]/page.tsx` (~line 175)
- What: Add 4-card grid showing Grant Amount, Estimated Costs, Profit, Margin %

**Epic 001: API Timeout Fix (Issues #106-#114)**

1. **#106:** Database - Add SearchJob model (CRITICAL - blocks all others)
   - Prisma schema: Add SearchJob model with type (FOOD/ACCOMMODATION/TRAVEL), status (PENDING/PROCESSING/COMPLETED/FAILED), results, error
   - Create migration
   - Add indexes on (organizationId, status) and (id, organizationId)

2. **#107:** Backend - Food agent Inngest function
   - Create `inngest/functions/food-agent-search.ts`
   - Move existing Food agent logic into background job
   - Update SearchJob status throughout lifecycle
   - 3 retry attempts with exponential backoff

3. **#108:** Backend - Accommodation agent Inngest function
   - Same pattern as #107 for Accommodation agent

4. **#109:** Backend - tRPC procedures for job management
   - Add `submitFoodSearch()` - creates job + triggers Inngest
   - Add `submitAccommodationSearch()` - same pattern
   - Add `getJobStatus(jobId)` - returns job state for polling
   - Authorization checks (organizationId match)

5. **#110:** Frontend - useSearchJob React Query hook
   - Polls every 2 seconds while PENDING/PROCESSING
   - Stops polling when COMPLETED/FAILED
   - Returns status, results, error

6. **#111:** Frontend - FoodSearchPanel polling UI
   - Replace synchronous API call with job submission
   - Show progress: "Searching for food options... (Usually 15-20 seconds)"
   - Display results when complete
   - Error message with retry button on failure

7. **#112:** Frontend - AccommodationSearchPanel polling UI
   - Same pattern as #111 for Accommodation

8. **#113:** Tests - E2E validation (Playwright)
   - Test Food agent job flow
   - Test Accommodation agent job flow
   - Test error handling
   - Test multi-tenant isolation

9. **#114:** Monitoring - Logging, metrics, alerts
   - Structured logging for job lifecycle
   - Metrics: submission rate, completion time, success/failure rates
   - Alerts: high failure rate (>10%), slow jobs (>60s)

### Dependency Chain
```
#106 (Database)
  â†“
#107 (Food Inngest) + #108 (Accommodation Inngest)
  â†“
#109 (tRPC procedures)
  â†“
#110 (React Query hook)
  â†“
#111 (Food UI) + #112 (Accommodation UI)
  â†“
#113 (E2E tests)
  â†“
#114 (Monitoring)
```

---

## Key Planning Artifacts

### Location: `/home/samuel/supervisor/openhorizon/.bmad/`

**project-brief.md** (Updated 2026-01-15)
- Real business model documented
- Primary user: Samuel
- Primary goal: Financial transparency for informed project decisions
- Success criteria: 3-5 real projects by February 2026

**workflow-status.yaml** (Updated 2026-01-15)
- Current phase: Implementation (91% complete)
- 3 epics: #001 (API timeouts), #002 (Auth stability), #003 (Production readiness)
- Critical path: Fix timeouts â†’ Fix auth â†’ Complete tests â†’ Validate production

**epics/001-fix-api-timeouts.md** (Created 2026-01-15)
- Comprehensive epic for vendor search timeout fix
- Business context: Blocks financial decision-making
- 9 issues with detailed acceptance criteria
- Architecture: Inngest background jobs + React Query polling

**ADRs (Created 2026-01-15):**
- ADR-001: Tech Stack (Next.js 16, React 19, TypeScript, Fastify, Prisma, LangChain)
- ADR-002: AI Architecture (LangChain + Anthropic Claude)
- ADR-003: Multi-tenancy (Organization-based isolation)
- ADR-004: Dual-mode Content (Working vs. Formal language)
- ADR-005: Pipeline Architecture (Separate Fastify service)

---

## SCAR Interaction Pattern

### How to Direct SCAR

**Starting new work:**
```bash
gh issue comment <issue-number> --body "@scar - Please implement <task>.

Epic context: <link to epic file if applicable>

Start with <specific first step>."
```

**Verification (mandatory before merge):**
```bash
# Option 1: Use verification subagent
/verify-scar-phase openhorizon.cc <issue-number> 2

# Option 2: Manual verification
# Read files in worktree: /home/samuel/.archon/worktrees/openhorizon.cc/issue-<number>/
# Check:
# - All claimed files exist and modified correctly
# - No mocks/placeholders
# - Build succeeds (npm run build)
# - Tests pass (npm test)
# - TypeScript has no errors
```

**Approval:**
```bash
gh issue comment <issue-number> --body "@scar APPROVED âœ… Create PR and merge"
```

**Rejection (with specific feedback):**
```bash
gh issue comment <issue-number> --body "@scar - Issues found:

1. <specific problem with file and line number>
2. <another specific problem>

Please fix these issues before creating PR."
```

### SCAR Acknowledgment Check (MANDATORY)

After mentioning @scar, wait 20 seconds and verify acknowledgment:
```bash
gh issue view <issue-number> --comments | grep "SCAR is on the case"
```

If no acknowledgment: Re-post with clearer @scar mention or alert user.

---

## Repository Structure

### Planning Workspace
**Location:** `/home/samuel/supervisor/openhorizon/`
**Git:** https://github.com/gpt153/openhorizon-planning

```
.bmad/
â”œâ”€â”€ project-brief.md (complete)
â”œâ”€â”€ workflow-status.yaml (complete)
â”œâ”€â”€ epics/
â”‚   â””â”€â”€ 001-fix-api-timeouts.md (complete)
â”œâ”€â”€ adr/
â”‚   â”œâ”€â”€ 001-tech-stack.md (complete)
â”‚   â”œâ”€â”€ 002-ai-architecture.md (complete)
â”‚   â”œâ”€â”€ 003-multi-tenancy.md (complete)
â”‚   â”œâ”€â”€ 004-dual-mode-content.md (complete)
â”‚   â””â”€â”€ 005-pipeline-architecture.md (complete)
â””â”€â”€ handoff-2026-01-15-18-57.md (this file)
```

### Implementation Workspace (SCAR's domain - READ ONLY for you)
**Location:** `/home/samuel/.archon/workspaces/openhorizon.cc/`
**Git:** https://github.com/gpt153/openhorizon.cc

**Key files for Epic 001:**
- Prisma schema: `prisma/schema.prisma`
- Inngest functions: `app/src/inngest/functions/`
- tRPC routers: `app/src/server/routers/pipeline/`
- React Query hooks: `app/src/lib/hooks/`
- UI components: `app/src/components/pipeline/`
- Profit dashboard: `app/src/app/(dashboard)/dashboard/profit/page.tsx`
- Pipeline project detail: `app/src/app/(dashboard)/pipeline/projects/[id]/page.tsx` (#105 target)

### Worktrees (SCAR's active work)
**Location:** `/home/samuel/.archon/worktrees/openhorizon.cc/issue-<number>/`

Active worktree: `issue-105/` (SCAR working on profit display)

---

## Immediate Next Actions

### Step 1: Check SCAR Progress on #105 (NOW)

```bash
# Check issue status
cd /home/samuel/.archon/workspaces/openhorizon.cc && gh issue view 105 --comments | tail -20

# Check worktree for changes
ls -la /home/samuel/.archon/worktrees/openhorizon.cc/issue-105/app/src/app/(dashboard)/pipeline/projects/[id]/ 2>/dev/null

# If SCAR posted "Implementation complete":
# â†’ Proceed to Step 2
# If SCAR still working:
# â†’ Wait and monitor (check every 5 minutes)
# If SCAR posted questions:
# â†’ Answer with context from epic/planning docs
```

### Step 2: Verify #105 Implementation (When SCAR completes)

**What to check:**
1. Read file: `/home/samuel/.archon/worktrees/openhorizon.cc/issue-105/app/src/app/(dashboard)/pipeline/projects/[id]/page.tsx`
2. Look for new card section around line 175 showing:
   - Grant Amount card
   - Estimated Costs card
   - Profit card
   - Profit Margin % card (with color coding)
3. Verify uses existing functions: `formatCurrency()`, `getProfitMarginColor()`, `calculateProfitMarginPercentage()`
4. Verify only displays when `erasmusGrantCalculated` exists
5. Check no TypeScript errors: Look for type issues in SCAR's implementation

**If approved:**
```bash
cd /home/samuel/.archon/workspaces/openhorizon.cc && gh issue comment 105 --body "@scar APPROVED âœ… Create PR and merge"
```

**If issues found:**
```bash
cd /home/samuel/.archon/workspaces/openhorizon.cc && gh issue comment 105 --body "@scar - Issues found:

1. [Specific issue with line number]
2. [Another specific issue]

Please fix before creating PR."
```

### Step 3: Start SCAR on Epic 001 (After #105 merged)

```bash
cd /home/samuel/.archon/workspaces/openhorizon.cc && gh issue comment 106 --body "@scar - Please implement Epic 001: Fix API Timeout Issues.

Epic file: https://github.com/gpt153/openhorizon-planning/blob/main/.bmad/epics/001-fix-api-timeouts.md

Start with Issue #106 (Database - Add SearchJob model). This is CRITICAL priority - blocks all other Epic 001 issues.

After completing #106, proceed to #107 (Food agent Inngest function) and work through #106-#114 in sequence.

This is the highest priority work blocking the February 2026 deadline."

# Wait 20 seconds, verify acknowledgment
sleep 20 && gh issue view 106 --comments | grep "SCAR is on the case"
```

### Step 4: Monitor Epic 001 Progress

**Set up proactive monitoring:**

1. **Check SCAR progress every 2 hours:**
   ```bash
   gh issue view <current-issue> --comments | tail -10
   ls -la /home/samuel/.archon/worktrees/openhorizon.cc/issue-<number>/
   ```

2. **When SCAR posts "Implementation complete":**
   - Immediately verify using `/verify-scar-phase openhorizon.cc <issue-number> 2`
   - Post approval or detailed feedback
   - Monitor next issue in sequence

3. **Track completion:**
   - Update `workflow-status.yaml` as issues complete
   - Mark epic progress in planning docs
   - Report to user proactively

---

## Critical Context for New Instance

### What User Expects

**User communication style:**
- Very brief, natural language
- Expects you to know what to do automatically
- Says "c" to mean "Option C"
- Says "start scar and supervise" expecting full workflow execution

**User does NOT code:**
- You handle ALL technical details
- You spawn subagents for complex work
- You interact with SCAR autonomously
- You verify, test, and validate everything

### Autonomous Behaviors (Do These Automatically)

1. **After @scar mention:** Wait 20s, verify acknowledgment
2. **When SCAR posts "complete":** Immediately spawn verification subagent
3. **Every 2 hours while SCAR works:** Check progress proactively
4. **When validation FAILS:** Post detailed feedback immediately
5. **Context at 80% (160K tokens):** Create next handoff document

### Tools and Patterns

**Use Archon MCP for:**
- Task tracking (manage_task, find_tasks)
- Searching best practices (rag_search_knowledge_base)
- Code examples (rag_search_code_examples)

**Spawn subagents for:**
- Complex planning (meta-orchestrator, PM, architect)
- Verification (/verify-scar-phase)
- Testing (Playwright, build validation)
- Research (Explore agent for codebase investigation)

**Context conservation:**
- Spawn subagents for >10 step tasks
- Spawn subagents when reading multiple files
- Keep main context for orchestration only
- Hand off at 80% (160K/200K tokens)

---

## Key Decisions & Rationale

### Decision 1: Corrected Business Model (2026-01-15)
**Before:** "Democratize Erasmus+ access for all organizations"
**After:** "Sustainable project management with financial transparency for Samuel's projects"
**Why:** User corrected - it's his income tool, not an altruistic platform
**Impact:** Reframed all planning docs to reflect real use case

### Decision 2: Profit Visibility Everywhere (User request)
**What:** Add profit/margin display to individual project views
**Why:** User needs financial visibility at project level, not just main dashboard
**How:** Issue #105 adds cards to Pipeline Project Detail page
**Future:** May need for regular Projects too (requires schema changes)

### Decision 3: Background Jobs for Vendor Search (Epic 001)
**Problem:** Food/Accommodation agents timeout at 30 seconds
**Solution:** Convert to Inngest background jobs with React Query polling
**Why:** Cloud Run has hard 30-second HTTP timeout limit
**Pattern:** Job submission â†’ Inngest execution â†’ Poll status â†’ Display results

### Decision 4: Epic 001 Takes Priority
**Rationale:** Vendor search is CRITICAL blocker for February 2026 deadline
**Sequence:** Database â†’ Inngest â†’ tRPC â†’ Frontend â†’ Tests â†’ Monitoring
**Timeline:** Must complete by January 22 to stay on track

---

## User Context & Background

**User:** Samuel (gpt153 on GitHub)
**Location:** Stockholm, Sweden
**Organization:** Swedish fÃ¶rening (non-profit association)
**Projects:** 3-5 Erasmus+ Youth Exchange projects annually
**Timeline:** February 2026 - real project applications due

**Use case:**
- Plans youth exchange projects (25-30 participants, 7-10 days)
- Calculates Erasmus+ grant amount using official unit costs
- Researches vendors (accommodation, food, travel) to estimate costs
- Compares grant vs. costs to see profit margin
- Decides which projects to pursue based on margin target
- Some projects break-even (community impact), others profitable (sustainable income)

**Pain point:**
- Manual vendor research takes 2-3 hours per destination
- Without clear cost data, can't make informed financial decisions
- Risk accepting unprofitable projects or rejecting viable ones
- Need systematic way to optimize margins across portfolio

**What OpenHorizon solves:**
- Budget calculator: Instant grant amount calculation
- Vendor search agents: AI finds accommodation/food/travel options in 20-30 seconds
- Profit dashboard: Real-time visibility into project economics
- Informed decision-making: Choose margin targets per project

---

## Known Issues & Warnings

### Issue 1: SCAR Taking Longer Than Expected on #105
- **Status:** SCAR has been working on #105 for ~28 minutes
- **Expected:** 5-10 minute task
- **Possible causes:**
  - Debugging UI rendering
  - Resolving TypeScript errors
  - Testing different card layouts
- **Action:** Continue monitoring, check for questions/blockers in comments

### Issue 2: Epic 001 Issues Not Created in Implementation Repo
- **What happened:** Issues #1-9 from earlier conversation were concept, not actual GitHub issues
- **Fixed:** Created issues #106-#114 in GitHub (2026-01-15)
- **Lesson:** Always verify issues exist in repo before referencing them

### Issue 3: Business Model Misunderstanding (CORRECTED)
- **Original error:** Framed as altruistic "democratize access" platform
- **User correction:** "i am the only user... keep the money that is left as my salary"
- **Fixed:** Updated all planning docs (project-brief, epic 001, workflow-status)
- **Lesson:** Read implementation code to understand real use case, not just high-level descriptions

### Issue 4: Profit Visibility Gap
- **Discovery:** Profit Dashboard exists, but project detail pages don't show profit
- **Root cause:** Data calculated but not rendered in UI
- **Fix:** Issue #105 adds profit cards to Pipeline Project Detail page
- **Future:** May need for regular Projects (different schema, deferred)

---

## Communication Patterns

### With User

**User says:** "plan feature X"
**You do:** Detect complexity â†’ Spawn meta-orchestrator â†’ Create epic + ADRs + issues â†’ Report "Epic created, SCAR notified"

**User says:** "check progress" or "is scar done?"
**You do:** Read issue comments + worktree files â†’ Report progress with ETA

**User says:** "c"
**You do:** Execute Option C from choices you presented

**User says:** "start scar and supervise"
**You do:** Mention @scar on issue â†’ Verify acknowledgment â†’ Monitor progress â†’ Report when complete

### With SCAR

**Starting work:**
```
@scar - Please implement <task>.

Epic context: <link if applicable>

Start with <specific step>.
```

**Approval:**
```
@scar APPROVED âœ… Create PR and merge
```

**Feedback:**
```
@scar - Issues found:

1. <specific file:line problem>
2. <another specific problem>

Please fix before creating PR.
```

### In Comments

- Be clear and direct
- Always include file paths and line numbers
- Reference epic/planning docs when relevant
- Give specific acceptance criteria

---

## Success Metrics

**You succeed when:**
- âœ… #105 completed and merged (profit display working)
- âœ… Epic 001 started and progressing systematically
- âœ… SCAR receives clear instructions and acknowledges within 20s
- âœ… No context mixing with other projects
- âœ… User understands progress without asking
- âœ… Context stays below 80% through handoffs

**Epic 001 succeeds when:**
- âœ… Food and Accommodation agents complete searches without timeouts
- âœ… Users see progress indicators during 15-20 second searches
- âœ… Search results provide actionable pricing data
- âœ… Profit Dashboard shows accurate estimated costs
- âœ… Samuel can plan 3-5 real projects by February 2026

---

## Final Context

**Current time:** 2026-01-15 18:57 Stockholm time
**Token usage when handed off:** ~68K / 200K (34%)
**Session duration:** ~2 hours
**Work completed:** Planning artifacts backfill + 10 GitHub issues created + SCAR started on #105

**What's working well:**
- Planning artifacts are comprehensive and accurate
- Issues have detailed implementation guidance
- SCAR has acknowledged and started work
- Supervision infrastructure in place

**What to watch:**
- SCAR taking longer than expected on #105 (monitor for blockers)
- Epic 001 is complex (9 sequential issues) - will need careful supervision
- February 2026 deadline is firm - must maintain velocity

**Your mission:**
Continue systematic supervision of SCAR through Epic 001 implementation. Ensure vendor search agents work reliably before February 2026 deadline. Maintain clear communication with user and proactive progress monitoring.

---

## Quick Reference Commands

```bash
# Check SCAR progress
gh issue view <number> --comments | tail -20
ls -la /home/samuel/.archon/worktrees/openhorizon.cc/issue-<number>/

# Verify SCAR's work
/verify-scar-phase openhorizon.cc <issue-number> 2

# Start SCAR on new issue
gh issue comment <number> --body "@scar - <instructions>"
sleep 20 && gh issue view <number> --comments | grep "SCAR is on the case"

# Approve SCAR's work
gh issue comment <number> --body "@scar APPROVED âœ… Create PR and merge"

# Update workflow status
# Edit: /home/samuel/supervisor/openhorizon/.bmad/workflow-status.yaml

# Create next handoff (at 80% context)
date '+%Y-%m-%d-%H-%M'
# Create: /home/samuel/supervisor/openhorizon/.bmad/handoff-<timestamp>.md
```

---

**Handoff complete. Next instance: Pick up from "Step 1: Check SCAR Progress on #105" above. Good luck! ðŸš€**
